{% extends 'hospital/base.html' %}

{% block title %}
    {% if appointments_data.active_role == 'patient' %}Mis Citas
    {% elif appointments_data.active_role == 'doctor' %}Citas de Pacientes
    {% elif appointments_data.active_role == 'admin' %}Todas las Citas
    {% else %}Citas{% endif %} - Hospital Management System
{% endblock %}

{% block page_title %}
    {% if appointments_data.active_role == 'patient' %}Mis Citas como Paciente
    {% elif appointments_data.active_role == 'doctor' %}Citas de Mis Pacientes
    {% elif appointments_data.active_role == 'admin' %}Todas las Citas del Sistema
    {% else %}Citas{% endif %}
{% endblock %}

{% block content %}
    <!-- Role-specific action buttons -->
    {% if appointments_data.active_role == 'patient' %}
        <p><a href="{% url 'hospital:create_appointment' %}">‚ûï Crear Nueva Cita</a></p>
        <p><em>Aqu√≠ puede ver las citas que ha programado con m√©dicos.</em></p>
    {% elif appointments_data.active_role == 'doctor' %}
        <p><em>Aqu√≠ puede ver las citas que los pacientes han programado con usted.</em></p>
    {% elif appointments_data.active_role == 'admin' %}
        <p><a href="{% url 'hospital:admin_panel' %}">‚öôÔ∏è Panel de Administraci√≥n</a></p>
        <p><em>Vista de todas las citas del sistema.</em></p>
    {% endif %}
    
    <h2>Lista de Citas ({{ appointments_data.total }} total)</h2>
    
    {% if appointments_data.appointments %}
        <table border="1">
            <thead>
                <tr>
                    <th>ID</th>
                    {% if appointments_data.active_role == 'doctor' %}
                        <th>Paciente</th>
                    {% elif appointments_data.active_role == 'patient' %}
                        <th>M√©dico</th>
                    {% else %}
                        <th>Paciente</th>
                        <th>M√©dico</th>
                    {% endif %}
                    <th>Fecha y Hora</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Motivo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for appointment in appointments_data.appointments %}
                <tr>
                    <td>{{ appointment.id }}</td>
                    
                    <!-- Role-specific column display -->
                    {% if appointments_data.active_role == 'doctor' %}
                        <!-- Doctor view: show patient info -->
                        <td>
                            {% if appointment.patient_name %}
                                <strong>{{ appointment.patient_name }}</strong><br>
                                <small>{{ appointment.patient_dni|default:appointment.patient_id }}</small>
                            {% else %}
                                Paciente ID: {{ appointment.patient_id }}
                            {% endif %}
                        </td>
                    {% elif appointments_data.active_role == 'patient' %}
                        <!-- Patient view: show doctor info -->
                        <td>
                            {% if appointment.doctor_name %}
                                <strong>{{ appointment.doctor_name }}</strong>
                                {% if appointment.doctor_specialidad %}
                                    <br><small><em>{{ appointment.doctor_specialidad }}</em></small>
                                {% endif %}
                            {% else %}
                                M√©dico ID: {{ appointment.doctor_profile_id }}
                            {% endif %}
                        </td>
                    {% else %}
                        <!-- Admin view: show both patient and doctor -->
                        <td>
                            {% if appointment.patient_name %}
                                <strong>{{ appointment.patient_name }}</strong><br>
                                <small>{{ appointment.patient_dni|default:appointment.patient_id }}</small>
                            {% else %}
                                Paciente ID: {{ appointment.patient_id }}
                            {% endif %}
                        </td>
                        <td>
                            {% if appointment.doctor_name %}
                                <strong>{{ appointment.doctor_name }}</strong>
                                {% if appointment.doctor_specialidad %}
                                    <br><small><em>{{ appointment.doctor_specialidad }}</em></small>
                                {% endif %}
                            {% else %}
                                M√©dico ID: {{ appointment.doctor_profile_id }}
                            {% endif %}
                        </td>
                    {% endif %}
                    
                    <td>{{ appointment.appointment_date|date:"d/m/Y H:i" }}</td>
                    <td>{{ appointment.appointment_type }}</td>
                    <td>
                        <strong>
                            {% if appointment.status == 'scheduled' %}üìÖ Programada
                            {% elif appointment.status == 'confirmed' %}‚úÖ Confirmada
                            {% elif appointment.status == 'in_progress' %}üîÑ En Curso
                            {% elif appointment.status == 'completed' %}‚úÖ Completada
                            {% elif appointment.status == 'cancelled' %}‚ùå Cancelada
                            {% elif appointment.status == 'no_show' %}‚ùå No Asisti√≥
                            {% elif appointment.status == 'rescheduled' %}üìÖ Reprogramada
                            {% else %}{{ appointment.status }}
                            {% endif %}
                        </strong>
                    </td>
                    <td>{{ appointment.reason|default:"-" }}</td>
                    <td>
                        <a href="{% url 'hospital:appointment_detail' appointment.id %}">Ver</a>
                        
                        <!-- Role-specific actions -->
                        {% if appointments_data.active_role == 'patient' %}
                            <!-- Patient actions: can cancel their own appointments -->
                            {% if appointment.status == 'scheduled' or appointment.status == 'confirmed' %}
                                | 
                                <form method="post" action="{% url 'hospital:cancel_appointment' appointment.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="text" name="cancellation_reason" placeholder="Motivo (opcional)" size="15">
                                    <button type="submit" onclick="return confirm('¬øEst√° seguro de cancelar esta cita?')">Cancelar</button>
                                </form>
                            {% endif %}
                        {% elif appointments_data.active_role == 'doctor' %}
                            <!-- Doctor actions: can confirm, complete, etc. -->
                            {% if appointment.status == 'scheduled' %}
                                | <a href="{% url 'hospital:confirm_appointment' appointment.id %}" onclick="return confirm('¬øConfirmar esta cita?')">‚úÖ Confirmar</a>
                            {% elif appointment.status == 'confirmed' %}
                                | <a href="{% url 'hospital:complete_appointment' appointment.id %}" onclick="return confirm('¬øMarcar como completada?')">‚úÖ Completar</a>
                            {% endif %}
                        {% elif appointments_data.active_role == 'admin' %}
                            <!-- Admin actions: full control -->
                            {% if appointment.status == 'scheduled' or appointment.status == 'confirmed' %}
                                | 
                                <form method="post" action="{% url 'hospital:cancel_appointment' appointment.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="text" name="cancellation_reason" placeholder="Motivo" size="15">
                                    <button type="submit" onclick="return confirm('¬øCancelar esta cita?')">‚ùå Cancelar</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <p><strong>P√°gina:</strong> {{ appointments_data.page }} | <strong>Tama√±o:</strong> {{ appointments_data.size }}</p>
        
    {% else %}
        {% if appointments_data.active_role == 'patient' %}
            <p>No tiene citas programadas como paciente.</p>
            <p><a href="{% url 'hospital:create_appointment' %}">Crear su primera cita</a></p>
        {% elif appointments_data.active_role == 'doctor' %}
            <p>No tiene citas programadas con pacientes.</p>
            <p><em>Los pacientes pueden programar citas con usted desde la lista de m√©dicos.</em></p>
        {% elif appointments_data.active_role == 'admin' %}
            <p>No hay citas en el sistema.</p>
        {% else %}
            <p>No hay citas.</p>
        {% endif %}
    {% endif %}
    
    <h3>Estados de Citas:</h3>
    <ul>
        <li><strong>üìÖ Programada:</strong> Cita creada, esperando confirmaci√≥n</li>
        <li><strong>‚úÖ Confirmada:</strong> Cita confirmada por el m√©dico</li>
        <li><strong>üîÑ En Curso:</strong> Cita actualmente en desarrollo</li>
        <li><strong>‚úÖ Completada:</strong> Cita finalizada exitosamente</li>
        <li><strong>‚ùå Cancelada:</strong> Cita cancelada</li>
        <li><strong>‚ùå No Asisti√≥:</strong> Paciente no se present√≥</li>
    </ul>
{% endblock %}