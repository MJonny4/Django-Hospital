{% extends 'hospital/base.html' %}

{% block title %}
    {% if appointments_data.active_role == 'patient' %}Mis Citas
    {% elif appointments_data.active_role == 'doctor' %}Citas de Mis Pacientes
    {% else %}Todas las Citas{% endif %} - Hospital Management System
{% endblock %}

{% block page_title %}
    {% if appointments_data.active_role == 'patient' %}<i class="bi bi-calendar-check me-3"></i>Mis Citas como Paciente
    {% elif appointments_data.active_role == 'doctor' %}<i class="bi bi-calendar-heart me-3"></i>Citas de Mis Pacientes
    {% elif appointments_data.active_role == 'admin' %}<i class="bi bi-calendar3 me-3"></i>Todas las Citas del Sistema
    {% else %}<i class="bi bi-calendar me-3"></i>Citas{% endif %}
{% endblock %}

{% block content %}
<!-- Alpine.js Enhanced Appointments Dashboard -->
<div x-data="appointmentsApp()" x-init="initializeData()" class="appointments-dashboard">
    
    <!-- Role-specific header and actions -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    {% if appointments_data.active_role == 'patient' %}
                        <p class="mb-2"><i class="bi bi-info-circle text-primary me-2"></i>Aqu√≠ puede ver las citas que ha programado con m√©dicos.</p>
                    {% elif appointments_data.active_role == 'doctor' %}
                        <p class="mb-2"><i class="bi bi-info-circle text-primary me-2"></i>Aqu√≠ puede ver las citas que los pacientes han programado con usted.</p>
                    {% elif appointments_data.active_role == 'admin' %}
                        <p class="mb-2"><i class="bi bi-info-circle text-primary me-2"></i>Vista completa de todas las citas del sistema.</p>
                    {% endif %}
                    
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2 text-primary"></i>
                        Lista de Citas 
                        <span class="badge bg-primary" x-text="filteredAppointments.length + ' total'"></span>
                    </h5>
                </div>
                <div class="col-md-4 text-end">
                    {% if appointments_data.active_role == 'patient' %}
                        <a href="{% url 'hospital:create_appointment' %}" class="btn btn-success">
                            <i class="bi bi-calendar-plus me-1"></i>Crear Nueva Cita
                        </a>
                    {% elif appointments_data.active_role == 'admin' %}
                        <a href="{% url 'hospital:admin_panel' %}" class="btn btn-outline-primary">
                            <i class="bi bi-gear me-1"></i>Panel de Administraci√≥n
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Filtrar por Estado</label>
                    <select x-model="filters.status" @change="applyFilters()" class="form-select">
                        <option value="">Todos los estados</option>
                        <option value="scheduled">Programada</option>
                        <option value="confirmed">Confirmada</option>
                        <option value="in_progress">En Curso</option>
                        <option value="completed">Completada</option>
                        <option value="cancelled">Cancelada</option>
                        <option value="no_show">No Asisti√≥</option>
                        <option value="rescheduled">Reprogramada</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Desde Fecha</label>
                    <input type="date" x-model="filters.date_from" @change="applyFilters()" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <div class="form-check">
                        <input type="checkbox" x-model="filters.hide_completed" @change="applyFilters()" 
                               class="form-check-input" id="hideCompleted">
                        <label class="form-check-label" for="hideCompleted">
                            Ocultar completadas y canceladas
                        </label>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <button @click="resetFilters()" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-clockwise me-1"></i>Limpiar
                    </button>
                    <button @click="expandAll()" class="btn btn-outline-primary">
                        <i class="bi bi-arrows-expand me-1"></i>Expandir Todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointments List -->
    <div class="row">
        <template x-for="appointment in filteredAppointments" :key="appointment.id">
            <div class="col-12 col-lg-6 mb-3">
                <div class="card shadow-sm appointment-card h-100" 
                     x-data="{ expanded: $store.expandedCards.includes(appointment.id) }"
                     :class="getStatusClass(appointment.status)"
                     :data-appointment-id="appointment.id" 
                     :data-status="appointment.status"
                     :data-priority="appointment.priority || 'normal'"
                     :data-type="appointment.appointment_type">
                    
                    <!-- Summary Header - Always Visible -->
                    <div class="card-header bg-white border-0 pb-2" 
                         @click="toggleExpansion(appointment.id)" 
                         style="cursor: pointer;">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <h6 class="mb-1 fw-bold text-primary">
                                    <i class="bi bi-person-badge me-1"></i>
                                    {% if appointments_data.active_role == 'patient' %}
                                        <span x-text="appointment.doctor_name ? 'Dr. ' + appointment.doctor_name : 'M√©dico #' + appointment.doctor_profile_id"></span>
                                    {% elif appointments_data.active_role == 'doctor' %}
                                        <span x-text="appointment.patient_name || 'Paciente #' + appointment.patient_id"></span>
                                    {% else %}
                                        <span x-text="'Cita #' + appointment.id"></span>
                                    {% endif %}
                                </h6>
                                {% if appointments_data.active_role == 'patient' %}
                                    <small class="text-muted" x-text="appointment.doctor_specialidad"></small>
                                {% elif appointments_data.active_role == 'doctor' %}
                                    <small class="text-muted" x-text="appointment.patient_dni ? 'DNI: ' + appointment.patient_dni : ''"></small>
                                {% else %}
                                    <small class="text-muted">
                                        <span x-text="appointment.patient_name || 'ID: ' + appointment.patient_id"></span>
                                        ‚Üí 
                                        <span x-text="appointment.doctor_name ? 'Dr. ' + appointment.doctor_name : 'ID: ' + appointment.doctor_profile_id"></span>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-4 text-end">
                                <span class="badge" :class="getStatusBadgeClass(appointment.status)" 
                                      x-text="getStatusText(appointment.status)"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Essential Info - Always Visible -->
                    <div class="card-body pb-2">
                        <div class="row">
                            <div class="col-7">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-calendar3 text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold" x-text="formatDate(appointment.appointment_date)"></div>
                                        <small class="text-muted" x-text="formatTime(appointment.appointment_date)"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-5 text-end">
                                <span class="badge" :class="getTypeBadgeClass(appointment.appointment_type)" 
                                      x-text="getTypeText(appointment.appointment_type)"></span>
                            </div>
                        </div>
                        
                        <!-- Toggle Button -->
                        <div class="text-center">
                            <button class="btn btn-sm details-toggle" 
                                    :class="expanded ? 'btn-secondary' : 'btn-outline-secondary'"
                                    @click="toggleExpansion(appointment.id)">
                                <i class="bi me-1" :class="expanded ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                                <span x-text="expanded ? 'Ocultar Detalles' : 'Ver Detalles'"></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Expandable Details -->
                    <div x-show="expanded" x-transition class="card-body pt-0 border-top">
                        <div class="row g-3">
                            <!-- Full Contact Information -->
                            {% if appointments_data.active_role == 'admin' %}
                                <div class="col-6">
                                    <h6 class="text-primary mb-2"><i class="bi bi-person me-1"></i>Paciente</h6>
                                    <div class="bg-light p-3 rounded">
                                        <div class="fw-semibold" x-text="appointment.patient_name || 'ID: ' + appointment.patient_id"></div>
                                        <small class="text-muted d-block" x-show="appointment.patient_dni" x-text="'DNI: ' + appointment.patient_dni"></small>
                                        <small class="text-muted d-block" x-show="appointment.patient_email" x-text="appointment.patient_email"></small>
                                        <small class="text-muted d-block" x-show="appointment.patient_telefono" x-text="appointment.patient_telefono"></small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-primary mb-2"><i class="bi bi-person-badge me-1"></i>M√©dico</h6>
                                    <div class="bg-light p-3 rounded">
                                        <div class="fw-semibold" x-text="appointment.doctor_name ? 'Dr. ' + appointment.doctor_name : 'ID: ' + appointment.doctor_profile_id"></div>
                                        <small class="text-muted d-block" x-show="appointment.doctor_specialidad" x-text="appointment.doctor_specialidad"></small>
                                        <small class="text-muted d-block" x-show="appointment.doctor_email" x-text="appointment.doctor_email"></small>
                                        <small class="text-muted d-block" x-show="appointment.doctor_telefono" x-text="appointment.doctor_telefono"></small>
                                    </div>
                                </div>
                            {% elif appointments_data.active_role == 'patient' %}
                                <div class="col-12">
                                    <h6 class="text-primary mb-2"><i class="bi bi-person-badge me-1"></i>Informaci√≥n del M√©dico</h6>
                                    <div class="bg-light p-3 rounded">
                                        <div class="fw-semibold" x-text="appointment.doctor_name ? 'Dr. ' + appointment.doctor_name : ''"></div>
                                        <small class="text-muted d-block" x-show="appointment.doctor_specialidad" x-text="appointment.doctor_specialidad"></small>
                                        <small class="text-muted d-block" x-show="appointment.doctor_email" x-text="appointment.doctor_email"></small>
                                        <small class="text-muted d-block" x-show="appointment.doctor_telefono" x-text="appointment.doctor_telefono"></small>
                                        <small class="text-muted d-block" x-show="appointment.doctor_hospital" x-text="appointment.doctor_hospital"></small>
                                    </div>
                                </div>
                            {% else %}
                                <div class="col-12">
                                    <h6 class="text-primary mb-2"><i class="bi bi-person me-1"></i>Informaci√≥n del Paciente</h6>
                                    <div class="bg-light p-3 rounded">
                                        <div class="fw-semibold" x-text="appointment.patient_name || ''"></div>
                                        <small class="text-muted d-block" x-show="appointment.patient_dni" x-text="'DNI: ' + appointment.patient_dni"></small>
                                        <small class="text-muted d-block" x-show="appointment.patient_email" x-text="appointment.patient_email"></small>
                                        <small class="text-muted d-block" x-show="appointment.patient_telefono" x-text="appointment.patient_telefono"></small>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Appointment Details -->
                            <div class="col-12">
                                <h6 class="text-primary mb-2"><i class="bi bi-clipboard-data me-1"></i>Detalles de la Cita</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Duraci√≥n:</small>
                                        <div x-text="(appointment.duration_minutes || 30) + ' minutos'"></div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Prioridad:</small>
                                        <div>
                                            <span class="badge" 
                                                  :class="getPriorityBadgeClass(appointment.priority || 'normal')"
                                                  x-text="getPriorityText(appointment.priority || 'normal')"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-2" x-show="appointment.reason">
                                    <small class="text-muted">Motivo de consulta:</small>
                                    <div class="text-break" x-text="appointment.reason"></div>
                                </div>
                                
                                <div class="mt-2" x-show="appointment.notes">
                                    <small class="text-muted">Notas adicionales:</small>
                                    <div class="text-break" x-text="appointment.notes"></div>
                                </div>
                            </div>
                            
                            <!-- Timeline Info -->
                            <div class="col-12">
                                <h6 class="text-primary mb-2"><i class="bi bi-clock-history me-1"></i>Informaci√≥n del Sistema</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Creada:</small>
                                        <div x-text="formatDateTime(appointment.created_at)"></div>
                                    </div>
                                    <div class="col-6" x-show="appointment.updated_at">
                                        <small class="text-muted">Modificada:</small>
                                        <div x-text="formatDateTime(appointment.updated_at)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions Footer -->
                    <div x-show="expanded" x-transition class="card-footer bg-light border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">ID: #<span x-text="appointment.id"></span></small>
                            <div class="btn-group">
                                <a :href="`{% url 'hospital:appointment_detail' 0 %}`.replace('0', appointment.id)" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>Ver M√°s
                                </a>
                                
                                <!-- Role-specific actions -->
                                {% if appointments_data.active_role == 'patient' %}
                                    <template x-if="['scheduled', 'confirmed'].includes(appointment.status)">
                                        <button @click="showCancelModal(appointment)" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-x-circle me-1"></i>Cancelar
                                        </button>
                                    </template>
                                {% elif appointments_data.active_role == 'doctor' %}
                                    <template x-if="appointment.status === 'scheduled'">
                                        <button @click="confirmAppointment(appointment)" class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-check-circle me-1"></i>Confirmar
                                        </button>
                                    </template>
                                    <template x-if="appointment.status === 'confirmed'">
                                        <button @click="completeAppointment(appointment)" class="btn btn-sm btn-outline-info">
                                            <i class="bi bi-check2-all me-1"></i>Completar
                                        </button>
                                    </template>
                                {% elif appointments_data.active_role == 'admin' %}
                                    <template x-if="['scheduled', 'confirmed'].includes(appointment.status)">
                                        <button @click="showCancelModal(appointment)" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash me-1"></i>Eliminar
                                        </button>
                                    </template>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Empty State -->
        <div class="col-12" x-show="filteredAppointments.length === 0 && !loading">
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    {% if appointments_data.active_role == 'patient' %}
                        <i class="bi bi-calendar-x display-1 text-muted mb-3"></i>
                        <h4>No tiene citas programadas</h4>
                        <p class="text-muted mb-4">A√∫n no has programado ninguna cita m√©dica.</p>
                        <a href="{% url 'hospital:create_appointment' %}" class="btn btn-success">
                            <i class="bi bi-calendar-plus me-1"></i>Crear su primera cita
                        </a>
                    {% elif appointments_data.active_role == 'doctor' %}
                        <i class="bi bi-calendar-heart display-1 text-muted mb-3"></i>
                        <h4>No tiene citas con pacientes</h4>
                        <p class="text-muted">Los pacientes pueden programar citas con usted desde la lista de m√©dicos.</p>
                    {% elif appointments_data.active_role == 'admin' %}
                        <i class="bi bi-calendar3 display-1 text-muted mb-3"></i>
                        <h4>No hay citas en el sistema</h4>
                        <p class="text-muted">El sistema no tiene citas registradas actualmente.</p>
                    {% else %}
                        <i class="bi bi-calendar display-1 text-muted mb-3"></i>
                        <h4>No hay citas disponibles</h4>
                        <p class="text-muted">No se encontraron citas para mostrar.</p>
                    {% endif %}
                    <button @click="resetFilters()" class="btn btn-outline-primary mt-2" x-show="hasActiveFilters()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pagination info -->
    <div class="d-flex justify-content-between align-items-center mt-3" x-show="filteredAppointments.length > 0">
        <div class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Mostrando <span x-text="filteredAppointments.length"></span> registros
            <span x-show="filteredAppointments.length !== appointments.length">
                de <span x-text="appointments.length"></span> total
            </span>
        </div>
    </div>
</div>

<!-- Appointment Status Guide -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>Gu√≠a de Estados de Citas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-warning me-2">üìÖ Programada</span>
                        <small>Cita creada, esperando confirmaci√≥n</small>
                    </div>
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-success me-2">‚úÖ Confirmada</span>
                        <small>Cita confirmada por el m√©dico</small>
                    </div>
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-info me-2">üîÑ En Curso</span>
                        <small>Cita actualmente en desarrollo</small>
                    </div>
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-success me-2">‚úÖ Completada</span>
                        <small>Cita finalizada exitosamente</small>
                    </div>
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-danger me-2">‚ùå Cancelada</span>
                        <small>Cita cancelada</small>
                    </div>
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-danger me-2">‚ùå No Asisti√≥</span>
                        <small>Paciente no se present√≥</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Appointment Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Cancelar Cita
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>¬øEst√° seguro de cancelar esta cita?</strong>
                </div>
                <div id="appointmentInfo" class="mb-3"></div>
                <form id="cancelForm" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="cancellation_reason" class="form-label">Motivo de la cancelaci√≥n (opcional)</label>
                        <textarea class="form-control" id="cancellation_reason" name="cancellation_reason" rows="3" placeholder="Describa el motivo de la cancelaci√≥n..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x me-1"></i>Mantener Cita
                </button>
                <button type="button" class="btn btn-danger" onclick="submitCancel()">
                    <i class="bi bi-trash me-1"></i>Cancelar Cita
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Pass Django data to JavaScript
const appointmentsData = {{ appointments_data|safe }};
const userRole = '{{ appointments_data.active_role }}';
</script>
{% endblock %}

{% block extra_js %}
<script>
// Alpine.js Store for global state management
document.addEventListener('alpine:init', () => {
    Alpine.store('expandedCards', []);
});

// Main Alpine.js component
function appointmentsApp() {
    return {
        // State
        appointments: [],
        filteredAppointments: [],
        loading: false,
        
        // Filters
        filters: {
            status: '',
            date_from: '',
            hide_completed: true
        },
        
        // Initialize with Django data
        initializeData() {
            this.loading = true;
            try {
                // Use Django data passed from template
                if (appointmentsData && appointmentsData.appointments) {
                    this.appointments = appointmentsData.appointments;
                } else {
                    this.appointments = [];
                }
                this.applyFilters();
                
                // Auto-expand urgent/emergency appointments after loading
                this.autoExpandUrgent();
            } catch (error) {
                console.error('Error initializing appointments:', error);
                this.appointments = [];
                this.filteredAppointments = [];
            } finally {
                this.loading = false;
            }
        },
        
        // Filtering with Alpine.js reactivity
        applyFilters() {
            let filtered = this.appointments;
            
            if (this.filters.status) {
                filtered = filtered.filter(a => a.status === this.filters.status);
            }
            
            if (this.filters.date_from) {
                const filterDate = new Date(this.filters.date_from);
                filtered = filtered.filter(a => new Date(a.appointment_date) >= filterDate);
            }
            
            if (this.filters.hide_completed) {
                filtered = filtered.filter(a => !['completed', 'cancelled', 'no_show'].includes(a.status));
            }
            
            this.filteredAppointments = filtered;
        },
        
        resetFilters() {
            this.filters = {
                status: '',
                date_from: '',
                hide_completed: true
            };
            this.applyFilters();
        },
        
        hasActiveFilters() {
            return this.filters.status || this.filters.date_from || !this.filters.hide_completed;
        },
        
        // Card expansion management
        toggleExpansion(appointmentId) {
            const store = Alpine.store('expandedCards');
            const index = store.indexOf(appointmentId);
            
            if (index > -1) {
                store.splice(index, 1);
            } else {
                store.push(appointmentId);
            }
        },
        
        expandAll() {
            Alpine.store('expandedCards', this.filteredAppointments.map(a => a.id));
        },
        
        autoExpandUrgent() {
            // Auto-expand urgent/emergency appointments
            const urgentAppointments = this.appointments.filter(a => 
                a.priority === 'urgent' || a.appointment_type === 'emergency'
            );
            
            setTimeout(() => {
                urgentAppointments.forEach(appointment => {
                    const store = Alpine.store('expandedCards');
                    if (!store.includes(appointment.id)) {
                        store.push(appointment.id);
                    }
                });
            }, 500);
        },
        
        // Date formatting utilities
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-ES');
        },
        
        formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        },
        
        formatDateTime(dateString) {
            return new Date(dateString).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        // Status and type utilities
        getStatusClass(status) {
            const classes = {
                scheduled: 'border-warning',
                confirmed: 'border-success', 
                in_progress: 'border-info',
                completed: 'border-success',
                cancelled: 'border-danger',
                no_show: 'border-danger',
                rescheduled: 'border-secondary'
            };
            return classes[status] || '';
        },
        
        getStatusBadgeClass(status) {
            const classes = {
                scheduled: 'bg-warning',
                confirmed: 'bg-success',
                in_progress: 'bg-info', 
                completed: 'bg-success',
                cancelled: 'bg-danger',
                no_show: 'bg-danger',
                rescheduled: 'bg-secondary'
            };
            return classes[status] || 'bg-secondary';
        },
        
        getStatusText(status) {
            const texts = {
                scheduled: 'üìÖ Programada',
                confirmed: '‚úÖ Confirmada',
                in_progress: 'üîÑ En Curso',
                completed: '‚úÖ Completada', 
                cancelled: '‚ùå Cancelada',
                no_show: '‚ùå No Asisti√≥',
                rescheduled: 'üìÖ Reprogramada'
            };
            return texts[status] || status;
        },
        
        getTypeBadgeClass(type) {
            const classes = {
                consultation: 'bg-primary',
                follow_up: 'bg-info',
                emergency: 'bg-danger',
                check_up: 'bg-success',
                procedure: 'bg-warning',
                vaccination: 'bg-secondary'
            };
            return classes[type] || 'bg-secondary';
        },
        
        getTypeText(type) {
            const texts = {
                consultation: 'ü©∫ Consulta',
                follow_up: 'üîÑ Seguimiento',
                emergency: 'üö® Urgencia',
                check_up: '‚úÖ Revisi√≥n',
                procedure: '‚öïÔ∏è Procedimiento',
                vaccination: 'üíâ Vacunaci√≥n'
            };
            return texts[type] || type;
        },
        
        getPriorityBadgeClass(priority) {
            const classes = {
                urgent: 'bg-danger',
                high: 'bg-warning', 
                normal: 'bg-success',
                low: 'bg-secondary'
            };
            return classes[priority] || 'bg-secondary';
        },
        
        getPriorityText(priority) {
            const texts = {
                urgent: 'Urgente',
                high: 'Alta',
                normal: 'Normal',
                low: 'Baja'
            };
            return texts[priority] || priority;
        },
        
        // Actions
        confirmAppointment(appointment) {
            if (confirm('¬øConfirmar esta cita?')) {
                // Redirect to confirmation URL
                window.location.href = `/appointments/${appointment.id}/confirm/`;
            }
        },
        
        completeAppointment(appointment) {
            if (confirm('¬øMarcar como completada?')) {
                // Redirect to completion URL
                window.location.href = `/appointments/${appointment.id}/complete/`;
            }
        },
        
        showCancelModal(appointment) {
            const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
            const form = document.getElementById('cancelForm');
            const appointmentInfo = document.getElementById('appointmentInfo');
            
            // Update form action
            form.action = `/appointments/${appointment.id}/cancel/`;
            
            // Update appointment info
            const doctorName = appointment.doctor_name || `ID: ${appointment.doctor_profile_id}`;
            const appointmentDate = this.formatDate(appointment.appointment_date) + ' ' + this.formatTime(appointment.appointment_date);
            
            appointmentInfo.innerHTML = `
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Detalles de la Cita:</h6>
                        <p class="card-text mb-1"><strong>M√©dico:</strong> Dr. ${doctorName}</p>
                        <p class="card-text mb-0"><strong>Fecha y Hora:</strong> ${appointmentDate}</p>
                    </div>
                </div>
            `;
            
            modal.show();
        }
    }
}

// Cancel modal functionality (keeping original structure for compatibility)
function submitCancel() {
    document.getElementById('cancelForm').submit();
}

// Add visual enhancements after DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects and animations to appointment cards
    setTimeout(() => {
        const appointmentCards = document.querySelectorAll('.appointment-card');
        appointmentCards.forEach(card => {
            const status = card.getAttribute('data-status');
            const priority = card.getAttribute('data-priority');
            const type = card.getAttribute('data-type');
            
            // Add priority-based styling
            if (priority === 'urgent' || type === 'emergency') {
                card.style.borderLeft = '4px solid var(--bs-danger)';
                if (type === 'emergency') {
                    card.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.2)';
                }
            } else if (priority === 'high') {
                card.style.borderLeft = '4px solid var(--bs-warning)';
            } else if (status === 'completed') {
                card.style.borderLeft = '4px solid var(--bs-success)';
                card.style.opacity = '0.8';
            } else if (status === 'cancelled') {
                card.style.borderLeft = '4px solid var(--bs-danger)';
                card.style.opacity = '0.7';
            }
            
            // Add hover effects
            card.addEventListener('mouseenter', function() {
                if (!['cancelled', 'completed'].includes(status)) {
                    this.style.transform = 'translateY(-3px)';
                    this.style.boxShadow = '0 10px 30px rgba(65, 105, 225, 0.2)';
                }
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
                
                // Restore emergency glow if needed
                if (type === 'emergency') {
                    this.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.2)';
                }
            });
        });
    }, 100);
});
</script>
{% endblock %}